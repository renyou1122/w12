from robot_lib import World as BaseWorld, AnimatedRobot as BaseRobot, timer, CELL_SIZE

# --- 1. å®šç¾©ä¸–ç•Œï¼ˆåŠ å…¥ç´°æ ¼ï¼‰ ---
class MyWorld(BaseWorld):
    def __init__(self, width=10, height=10, sub_cell=5):
        super().__init__(width, height)
        self.sub_cell = sub_cell
        self.sub_size = CELL_SIZE // sub_cell
        self._draw_fine_grid()

    def _draw_fine_grid(self):
        ctx = self.layers["grid"].getContext("2d")
        ctx.strokeStyle = "#e0e0e0"
        ctx.lineWidth = 0.5
        # ç•«å‚ç›´ç´°ç·š
        for i in range(self.width * self.sub_cell + 1):
            x = i * self.sub_size
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, self.height * CELL_SIZE); ctx.stroke()
        # ç•«æ°´å¹³ç´°ç·š
        for j in range(self.height * self.sub_cell + 1):
            y = j * self.sub_size
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(self.width * CELL_SIZE, y); ctx.stroke()

    # ç´°æ ¼åº§æ¨™è½‰æ›ç‚ºåƒç´ åº§æ¨™
    def sub_to_px(self, sub_x, sub_y):
        # è¢å¹• X è»¸ï¼šå·¦->å³ (sub_x è¶Šå¤§ï¼Œpx è¶Šå¤§)
        px = sub_x * self.sub_size + self.sub_size // 2
        
        # è¢å¹• Y è»¸ï¼šä¸Š->ä¸‹ (sub_y è¶Šå¤§ï¼Œpy è¶Šå¤§)
        # ç”±æ–¼ sub_y å·²ç¶“è¢«è¨­è¨ˆæˆã€Œè¶Šå¾€ä¸‹æ•¸å€¼è¶Šå¤§ã€ï¼Œæˆ‘å€‘ä¸å†éœ€è¦åƒ BaseWorld é‚£æ¨£åè½‰
        py = sub_y * self.sub_size + self.sub_size // 2
        return px, py

    # åœ¨ç´°æ ¼åº§æ¨™ä¸Šç•«ç·š
    def draw_line(self, x1, y1, x2, y2):
        ctx = self.layers["objects"].getContext("2d")
        ctx.strokeStyle = "#d33"
        ctx.lineWidth = 9
        ctx.lineCap = "round"
        ctx.beginPath()
        ctx.moveTo(*self.sub_to_px(x1, y1))
        ctx.lineTo(*self.sub_to_px(x2, y2))
        ctx.stroke()

# --- 2. å®šç¾©æ©Ÿå™¨äººï¼ˆä»¥ç´°æ ¼ç§»å‹•ï¼‰ ---
class MyRobot(BaseRobot):
    def __init__(self, world, start_sub_x=1, start_sub_y=1):
        super().__init__(world, start_sub_x // world.sub_cell, start_sub_y // world.sub_cell)
        # åˆå§‹ä½ç½®è½‰æ›ç‚ºç´°æ ¼ä¸­å¿ƒ
        self.sub_x = start_sub_x # å·²ç¶“æ˜¯ç´°æ ¼ä¸­å¿ƒ
        self.sub_y = start_sub_y # å·²ç¶“æ˜¯ç´°æ ¼ä¸­å¿ƒ
        self.robot_size = world.sub_size * 1.8

    # é‡æ–°ç¹ªè£½æ©Ÿå™¨äººï¼ˆä½¿ç”¨ç´°æ ¼åº§æ¨™ï¼‰
    def _draw_robot(self):
        self.robot_ctx.clearRect(0, 0, self.world.width * CELL_SIZE, self.world.height * CELL_SIZE)
        img = self.images[self.facing]
        px, py = self.world.sub_to_px(self.sub_x, self.sub_y)
        s = self.robot_size
        if img.complete:
            self.robot_ctx.drawImage(img, px - s//2, py - s//2, s, s)

    # ç¬é–“ç§»å‹•ï¼ˆä¸ç•«ç·šï¼‰
    def teleport_to(self, tx, ty):
        def action(done):
            self.sub_x, self.sub_y = tx, ty
            self._draw_robot()
            timer.set_timeout(done, 10)
        self.queue.append(action)
        self._run_queue()

    # ç§»å‹• + ç•«ç·šï¼ˆæœ€æ ¸å¿ƒï¼‰
    def move_to(self, tx, ty, draw_trace=True):
        def action(done):
            def step():
                if self.sub_x == tx and self.sub_y == ty:
                    done(); return
                prev_x, prev_y = self.sub_x, self.sub_y

                # è¨ˆç®—æ–¹å‘ä¸¦è½‰å‘
                dx = tx - self.sub_x
                dy = ty - self.sub_y
                
                # æ©Ÿå™¨äººé¢å‘çš„æ–¹å‘ (BaseRobot æ–¹å‘ï¼šNä¸Š/Sä¸‹/Eå³/Wå·¦)
                # sub_x å¢å¤§ï¼šE
                if dx > 0:    target = "E"
                # sub_x æ¸›å°ï¼šW
                elif dx < 0: target = "W"
                # sub_y å¢å¤§ (è¢å¹•ä¸Šå¾€ä¸‹)ï¼šS ğŸ‘ˆ é—œéµä¿®æ­£é»
                elif dy > 0: target = "S"
                # sub_y æ¸›å° (è¢å¹•ä¸Šå¾€ä¸Š)ï¼šN ğŸ‘ˆ é—œéµä¿®æ­£é»
                else:       target = "N" 

                # åŒæ­¥è½‰å‘
                # é€™è£¡çš„è½‰å‘é‚è¼¯å¯ä»¥ç°¡åŒ–ï¼Œç›´æ¥è¨­å®š facing å³å¯ï¼Œå› ç‚ºåªéœ€è¦ç¢ºä¿é¢å‘æ­£ç¢º
                self.facing = target 

                # ç§»å‹•ä¸€æ­¥
                self.sub_x += 1 if dx > 0 else (-1 if dx < 0 else 0)
                self.sub_y += 1 if dy > 0 else (-1 if dy < 0 else 0)

                if draw_trace:
                    self.world.draw_line(prev_x, prev_y, self.sub_x, self.sub_y)
                self._draw_robot()
                # èª¿æ•´é€Ÿåº¦ï¼Œè®“ç·šæ¢æ›´å¹³æ»‘
                timer.set_timeout(step, 10) # åŠ å¿«é€Ÿåº¦
            step()
        self.queue.append(action)
        self._run_queue()

# --- 3. ä¸ƒæ®µé¡¯ç¤ºå™¨å®šç¾© ---
SEGMENTS = {
    0:[1,1,1,1,1,1,0], 1:[0,1,1,0,0,0,0], 2:[1,1,0,1,1,0,1],
    3:[1,1,1,1,0,0,1], 4:[0,1,1,0,0,1,1], 5:[1,0,1,1,0,1,1],
    6:[1,0,1,1,1,1,1], 7:[1,1,1,0,0,0,0], 8:[1,1,1,1,1,1,1],
    9:[1,1,1,1,0,1,1]
}

# æ¯å€‹ç·šæ®µçš„ç´°æ ¼åº§æ¨™è·¯å¾‘ï¼ˆç›¸å°åº§æ¨™ï¼‰
# Y è»¸ï¼š0 (é ‚éƒ¨) -> 6 (åº•éƒ¨)
PATHS = [
    [(0,0),(1,0),(2,0),(3,0)],             # A ä¸Š
    [(3,0),(3,1),(3,2),(3,3)],             # B å³ä¸Š
    [(3,3),(3,4),(3,5),(3,6)],             # C å³ä¸‹
    [(3,6),(2,6),(1,6),(0,6)],             # D ä¸‹
    [(0,6),(0,5),(0,4),(0,3)],             # E å·¦ä¸‹
    [(0,3),(0,2),(0,1),(0,0)],             # F å·¦ä¸Š
    [(0,3),(1,3),(2,3),(3,3)]              # G ä¸­
]

def draw_digit(robot, digit, ox, oy):
    if digit not in SEGMENTS: return
    for i, on in enumerate(SEGMENTS[digit]):
        if not on: continue
        path = PATHS[i]
        
        # ç§»å‹•åˆ°ç·šæ®µèµ·é»
        start_x = ox + path[0][0]
        start_y = oy + path[0][1] 
        robot.teleport_to(start_x, start_y)
        
        # ç•«å‡ºç·šæ®µ
        for j in range(1, len(path)):
            tx = ox + path[j][0]
            ty = oy + path[j][1] 
            robot.move_to(tx, ty, draw_trace=True)

# ==================== ä¸»ç¨‹å¼ï¼šç•« 0123456789 ====================
# ä½¿ç”¨æ›´å¤§çš„ä¸–ç•Œï¼Œä»¥ä¾¿å®¹ç´æ‰€æœ‰æ•¸å­—
world = MyWorld(width=15, height=10, sub_cell=5) 

# æ•¸å­—å·¦ä¸Šè§’çš„èµ·å§‹ç´°æ ¼ Y åº§æ¨™
START_Y_SUB_CELL = 2

# æ©Ÿå™¨äººå¾ç¬¬ä¸€å€‹æ•¸å­—çš„èµ·é»é–‹å§‹
robot = MyRobot(world, 0, 0) # åˆå§‹ä½ç½®ä¸é‡è¦ï¼Œå› ç‚ºæœƒé¦¬ä¸Š teleport

for i in range(10):
    # æ¯å€‹æ•¸å­—çš„èµ·å§‹ X ç´°æ ¼åº§æ¨™
    # æ•¸å­—å¯¬åº¦ç‚º 4 æ ¼ï¼Œé–“éš” 2 æ ¼ï¼Œç¸½å…± 6 æ ¼
    start_x_offset = 1 + i * 5 
    draw_digit(robot, i, start_x_offset, START_Y_SUB_CELL)

print("æ©Ÿå™¨äººæ­£åœ¨å¯«å­—ï¼š0123456789 (å·²ä¿®æ­£ Y è»¸æ–¹å‘åˆ¤æ–·èˆ‡é€Ÿåº¦)")
